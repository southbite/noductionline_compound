<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="bootstrap.css">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="navbar">
            <div class="navbar-inner">
                <div class="container">
                    <span class="brand">Railway Routes Test Coverage</span>
                    <ul class="nav">
                        <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="#lib">./lib (64%)</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="span6" style="margin-top: 10px;">
                        <div class="progress progress-warning"> <div class="bar" style="width: 64%"><strong>64%</strong> [96/149]</div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="group-header row" id="lib"><div class="group-name span5">./lib</div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 64%"><strong>64%</strong> [96/149]</div></div></div></div><div id="lib-railway-routes-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-railway-routes-js" class="filename trigger" name="lib-railway-routes-js">lib/railway_routes.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 64%"><strong>64%</strong> [96/149]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> singularize = <span class="func">require</span>(<span class="S">'../support/inflection'</span>).singularize;</code></li><li class=""><code></code></li><li class="covered"><code>exports.Map = Map;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Routing map drawer. Encapsulates all logic required for drawing maps:</span></code></li><li class=""><code><span class="C"> * namespaces, resources, get, post, put, ..., all requests</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} app - RailwayJS or ExpressJS application</span></code></li><li class=""><code><span class="C"> * @param {Function} bridge - some bridge method that will server requests from</span></code></li><li class=""><code><span class="C"> * routing map to application</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Usage example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     var map = new require('railway-routes').Map(app, handler);</span></code></li><li class=""><code><span class="C"> *     map.resources('posts');</span></code></li><li class=""><code><span class="C"> *     map.namespace('admin', function (admin) {</span></code></li><li class=""><code><span class="C"> *        admin.resources('users');</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example `handler` loads controller and performs required action:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     function handler(ns, controller, action) {</span></code></li><li class=""><code><span class="C"> *         try {</span></code></li><li class=""><code><span class="C"> *             var ctlFile = './controllers/' + ns + controller + '_controller';</span></code></li><li class=""><code><span class="C"> *             var responseHandler =  require(ctlFile)[action];</span></code></li><li class=""><code><span class="C"> *         } catch(e) {}</span></code></li><li class=""><code><span class="C"> *         return responseHandler || function (req, res) {</span></code></li><li class=""><code><span class="C"> *             res.send('Handler not found for ' + ns + controller + '#' + action);</span></code></li><li class=""><code><span class="C"> *         };</span></code></li><li class=""><code><span class="C"> *     }</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Map</span>(app, bridge) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!(this instanceof Map)) <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">Map</span>(app, bridge);</code><span class="hits">7</span></li><li class="covered"><code>    this.app = app;</code><span class="hits">7</span></li><li class="covered"><code>    this.bridge = bridge;</code><span class="hits">7</span></li><li class="covered"><code>    this.paths = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">7</span></li><li class="covered"><code>    this.ns = <span class="S">''</span>;</code><span class="hits">7</span></li><li class=""><code>    <span class="C">// wtf???</span></code></li><li class="covered"><code>    this.globPath = <span class="S">'/'</span>;</code><span class="hits">7</span></li><li class="covered"><code>    this.pathTo = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">7</span></li><li class="covered"><code>    this.dump = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">7</span></li><li class="covered"><code>    this.middlewareStack = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">7</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Calculate url helper name for given path and action</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} path</span></code></li><li class=""><code><span class="C"> * @param {String} action</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.urlHelperName = <span class="kwrd">function</span> (path, action) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (path instanceof RegExp) <span class="gly">{</span></code></li><li class="uncovered"><code>        path = path.<span class="func">toString</span>().<span class="func">replace</span>(/<span class="gly">[</span>^a-z<span class="gly">]</span>+/ig, <span class="S">'/'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// handle root paths</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (path === <span class="S">''</span> <span class="gly">|</span><span class="gly">|</span> path === <span class="S">'/'</span>) <span class="kwrd">return</span> <span class="S">'root'</span>;</code><span class="hits">49</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// remove trailing slashes and split to parts</span></code></li><li class="covered"><code>    path = path.<span class="func">replace</span>(/^\/<span class="gly">|</span>\/$/g, <span class="S">''</span>).<span class="func">split</span>(<span class="S">'/'</span>);</code><span class="hits">49</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> helperName = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">49</span></li><li class=""><code>    path.<span class="func">forEach</span>(<span class="kwrd">function</span> (token, index, all) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// skip variables</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (token<span class="gly">[</span>0<span class="gly">]</span> == <span class="S">':'</span>) <span class="kwrd">return</span>;</code><span class="hits">73</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> nextToken = all<span class="gly">[</span>index + 1<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code><span class="hits">73</span></li><li class=""><code>        <span class="C">// current token is last?</span></code></li><li class=""><code>        <span class="kwrd">if</span> (index == all.length - 1) <span class="gly">{</span></code></li><li class="covered"><code>            token = token.<span class="func">replace</span>(/\.:format\??$/, <span class="S">''</span>);</code><span class="hits">37</span></li><li class=""><code>            <span class="C">// same as action? - prepend</span></code></li><li class=""><code>            <span class="kwrd">if</span> (token == action) <span class="gly">{</span></code></li><li class="covered"><code>                helperName.<span class="func">unshift</span>(token);</code><span class="hits">8</span></li><li class="covered"><code>                <span class="kwrd">return</span>;</code><span class="hits">8</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (nextToken<span class="gly">[</span>0<span class="gly">]</span> == <span class="S">':'</span> <span class="gly">|</span><span class="gly">|</span> nextToken == <span class="S">'new.:format?'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            token = <span class="func">singularize</span>(token) <span class="gly">|</span><span class="gly">|</span> token;</code><span class="hits">20</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        helperName.<span class="func">push</span>(token);</code><span class="hits">65</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">49</span></li><li class="covered"><code>    <span class="kwrd">return</span> helperName.jo<span class="kwrd">in</span>(<span class="S">'_'</span>);</code><span class="hits">49</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Map root url</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.root = <span class="kwrd">function</span> (handler, middleware, options) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">get</span>(<span class="S">'/'</span>, handler, middleware, options);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="gly">[</span><span class="S">'get'</span>, <span class="S">'post'</span>, <span class="S">'put'</span>, <span class="S">'delete'</span>, <span class="S">'del'</span>, <span class="S">'all'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span> (method) <span class="gly">{</span></code></li><li class=""><code>    Map.<span class="kwrd">prototype</span><span class="gly">[</span>method<span class="gly">]</span> = <span class="kwrd">function</span> (subpath, handler, middleware, options) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> controller, action;</code><span class="hits">31</span></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> handler === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            controller = handler.<span class="func">split</span>(<span class="S">'#'</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">31</span></li><li class="covered"><code>            action = handler.<span class="func">split</span>(<span class="S">'#'</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">31</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> path;</code><span class="hits">31</span></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> subpath === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            path = this.globPath + subpath.<span class="func">replace</span>(/^\/<span class="gly">|</span>\/$/, <span class="S">''</span>);</code><span class="hits">31</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span> <span class="C">// regex???</span></code></li><li class="uncovered"><code>            path = subpath;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// only accept functions in before filter when it's an array</span></code></li><li class=""><code>        <span class="kwrd">if</span> (middleware instanceof Array) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> before_filter_functions = middleware.<span class="func">filter</span>(<span class="kwrd">function</span>(filter) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> (<span class="kwrd">typeof</span> filter === <span class="S">'function'</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>            middleware = before_filter_functions.length &gt; 0 ? before_filter_functions : null;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!(<span class="kwrd">typeof</span> middleware === <span class="S">'function'</span> <span class="gly">|</span><span class="gly">|</span> (middleware instanceof Array)) &amp;&amp; <span class="kwrd">typeof</span> options === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            options = middleware;</code><span class="hits">10</span></li><li class="covered"><code>            middleware = null;</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!options) <span class="gly">{</span></code></li><li class="covered"><code>            options = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        path = options.collection ? path.<span class="func">replace</span>(/\/:.*_id/, <span class="S">''</span>) : path;</code><span class="hits">31</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> args = <span class="gly">[</span>path<span class="gly">]</span>;</code><span class="hits">31</span></li><li class=""><code>        <span class="kwrd">if</span> (middleware) <span class="gly">{</span></code></li><li class="uncovered"><code>            args = args.<span class="func">concat</span>(this.middlewareStack.<span class="func">concat</span>(middleware));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        args = args.<span class="func">concat</span>(this.<span class="func">bridge</span>(this.ns, controller, action, options));</code><span class="hits">31</span></li><li class=""><code></code></li><li class=""><code>        this.dump.<span class="func">push</span>(<span class="gly">{</span></code></li><li class=""><code>            helper: options.as <span class="gly">|</span><span class="gly">|</span> this.<span class="func">urlHelperName</span>(path, action),</code></li><li class=""><code>            method: method,</code></li><li class=""><code>            path: path,</code></li><li class=""><code>            file: this.ns + controller,</code></li><li class=""><code>            name: controller,</code></li><li class=""><code>            action: action</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">31</span></li><li class=""><code></code></li><li class="covered"><code>        this.<span class="func">addPath</span>(path, action, options.as);</code><span class="hits">31</span></li><li class=""><code></code></li><li class="covered"><code>        this.app<span class="gly">[</span>method<span class="gly">]</span>.<span class="func">apply</span>(this.app, args);</code><span class="hits">31</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">6</span></li><li class="covered"><code><span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add path helper to `pathTo` collection</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.addPath = <span class="kwrd">function</span> (templatePath, action, helperName) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> app = this.app;</code><span class="hits">31</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (templatePath instanceof RegExp) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// TODO: think about adding to `path_to` routes by reg ex</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> paramsLength = templatePath.<span class="func">match</span>(/\/:/g);</code><span class="hits">31</span></li><li class="covered"><code>    paramsLength = paramsLength === null ? 0 : paramsLength.length;</code><span class="hits">31</span></li><li class="covered"><code>    helperName = helperName <span class="gly">|</span><span class="gly">|</span> this.<span class="func">urlHelperName</span>(templatePath, action);</code><span class="hits">31</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// already defined? not need to redefine</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (this.pathTo<span class="gly">[</span>helperName<span class="gly">]</span>) <span class="kwrd">return</span>;</code><span class="hits">20</span></li><li class=""><code></code></li><li class=""><code>    this.pathTo<span class="gly">[</span>helperName<span class="gly">]</span> = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (arguments.length &lt; paramsLength) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="S">''</span>;</code></li><li class=""><code>            <span class="C">// throw new Error('Expected at least ' + paramsLength + ' params for build path ' + templatePath + ' but only ' + arguments.length + ' passed');</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> value, arg, path = templatePath;</code><span class="hits">25</span></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0; i &lt; paramsLength; i += 1) <span class="gly">{</span></code></li><li class="covered"><code>            value = null;</code><span class="hits">8</span></li><li class="covered"><code>            arg = arguments<span class="gly">[</span>i<span class="gly">]</span>;</code><span class="hits">8</span></li><li class=""><code>            <span class="kwrd">if</span> (arg &amp;&amp; <span class="kwrd">typeof</span> arg.to_param == <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                value = arg.<span class="func">to_param</span>();</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (<span class="kwrd">typeof</span> arg === <span class="S">'object'</span> &amp;&amp; arg.id &amp;&amp; arg.constructor.name !== <span class="S">'ObjectID'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                value = arg.id;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                value = arg &amp;&amp; arg.toString ? arg.<span class="func">toString</span>() : arg;</code><span class="hits">8</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            path = path.<span class="func">replace</span>(/:\w*/, <span class="S">''</span> + value);</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (arguments<span class="gly">[</span>paramsLength<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> query = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> key <span class="kwrd">in</span> arguments<span class="gly">[</span>paramsLength<span class="gly">]</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (key == <span class="S">'format'</span> &amp;&amp; path.<span class="func">match</span>(/\.:format\??$/)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    path = path.<span class="func">replace</span>(/\.:format\??$/, <span class="S">'.'</span> + arguments<span class="gly">[</span>paramsLength<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    query.<span class="func">push</span>(key + <span class="S">'='</span> + arguments<span class="gly">[</span>paramsLength<span class="gly">]</span><span class="gly">[</span>key<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (query.length) <span class="gly">{</span></code></li><li class="uncovered"><code>                path += <span class="S">'?'</span> + query.jo<span class="kwrd">in</span>(<span class="S">'&amp;'</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        path = path.<span class="func">replace</span>(/\.:format\?/, <span class="S">''</span>);</code><span class="hits">25</span></li><li class=""><code>        <span class="C">// add ability to hook url handling via app</span></code></li><li class=""><code>        <span class="kwrd">if</span> (this.app.hooks &amp;&amp; this.app.hooks.path) <span class="gly">{</span></code></li><li class=""><code>            this.app.hooks.path.<span class="func">forEach</span>(<span class="kwrd">function</span> (hook) <span class="gly">{</span></code></li><li class="uncovered"><code>                path = <span class="func">hook</span>(path);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> appprefix = <span class="S">''</span>;</code><span class="hits">25</span></li><li class=""><code>        <span class="kwrd">if</span> (app.path) <span class="gly">{</span></code></li><li class="uncovered"><code>            appprefix = app.<span class="func">path</span>();</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            appprefix = app.<span class="func">set</span>(<span class="S">'basepath'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code><span class="hits">25</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> appprefix + path;</code><span class="hits">25</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this);</code><span class="hits">20</span></li><li class=""><code>    this.pathTo<span class="gly">[</span>helperName<span class="gly">]</span>.toString = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> this.pathTo<span class="gly">[</span>helperName<span class="gly">]</span>();</code><span class="hits">8</span></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this);</code><span class="hits">20</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Resources mapper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     map.resources('users');</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.resources = <span class="kwrd">function</span> (name, params, actions) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">3</span></li><li class=""><code>    <span class="C">// params are optional</span></code></li><li class="covered"><code>    params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// if params arg omitted, second arg may be `actions`</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params == <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        actions = params;</code></li><li class="uncovered"><code>        params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    </code></li><li class="covered"><code>    params.appendFormat = (<span class="S">'appendFormat'</span> <span class="kwrd">in</span> params) ? params.appendFormat : true;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// If resource uses the path param, it's subroutes should be</span></code></li><li class=""><code>    <span class="C">// prefixed by path, not the resource's name</span></code></li><li class=""><code>    <span class="C">// i.e.:</span></code></li><li class=""><code>    <span class="C">// map.resource('users', {path: ':username'}, function(user) {</span></code></li><li class=""><code>    <span class="C">//   user.resources('posts);</span></code></li><li class=""><code>    <span class="C">// });</span></code></li><li class=""><code>    <span class="C">// </span></code></li><li class=""><code>    <span class="C">// /:username/posts.:format?</span></code></li><li class=""><code>    <span class="C">// /:username/posts/new.:format?</span></code></li><li class=""><code>    <span class="C">// etc.</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> prefix = params.path ? params.path : name;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// we have bunch of actions here, will create routes for them</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> activeRoutes = <span class="func">getActiveRoutes</span>(params);</code><span class="hits">3</span></li><li class=""><code>    <span class="C">// but first, create subroutes</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> actions == <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (params.singleton)</code></li><li class=""><code>          this.<span class="func">subroutes</span>(prefix, actions); <span class="C">// singletons don't need to specify an id</span></code></li><li class=""><code>        else</code></li><li class="uncovered"><code>          this.<span class="func">subroutes</span>(prefix + <span class="S">'/:'</span> + (<span class="func">singularize</span>(name) <span class="gly">|</span><span class="gly">|</span> name) + <span class="S">'_id'</span>, actions);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="C">// now let's walk through action routes</span></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> action <span class="kwrd">in</span> activeRoutes) <span class="gly">{</span></code></li><li class=""><code>        (<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> route = activeRoutes<span class="gly">[</span>action<span class="gly">]</span>.<span class="func">split</span>(/\s+/);</code><span class="hits">21</span></li><li class="covered"><code>            <span class="kwrd">var</span> method = route<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">21</span></li><li class="covered"><code>            <span class="kwrd">var</span> path = route<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>            <span class="C">// append format</span></code></li><li class=""><code>            <span class="kwrd">if</span> (params.appendFormat !== false) <span class="gly">{</span></code></li><li class=""><code>              <span class="kwrd">if</span> (path == <span class="S">'/'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                  path = <span class="S">'.:format?'</span>;</code><span class="hits">6</span></li><li class=""><code>              <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                  path += <span class="S">'.:format?'</span>;</code><span class="hits">15</span></li><li class=""><code>              <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// middleware logic (backward compatibility)</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> middlewareExcept = params.middlewareExcept, skipMiddleware = false;</code><span class="hits">21</span></li><li class=""><code>            <span class="kwrd">if</span> (middlewareExcept) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="kwrd">typeof</span> middlewareExcept == <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    middlewareExcept = <span class="gly">[</span>middlewareExcept<span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>                middlewareExcept.<span class="func">forEach</span>(<span class="kwrd">function</span> (a) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (a == action) <span class="gly">{</span></code></li><li class="uncovered"><code>                        skipMiddleware = true;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// params.path setting allows to override common path component</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> effectivePath = (params.path <span class="gly">|</span><span class="gly">|</span> name) + path;</code><span class="hits">21</span></li><li class=""><code></code></li><li class="covered"><code>            <span class="kwrd">var</span> controller = params.controller <span class="gly">|</span><span class="gly">|</span> name;</code><span class="hits">21</span></li><li class=""><code></code></li><li class=""><code>            <span class="C">// and call map.{get|post|update|delete}</span></code></li><li class=""><code>            <span class="C">// with the path, controller, middleware and options</span></code></li><li class=""><code>            this<span class="gly">[</span>method.toLower<span class="kwrd">Case</span>()<span class="gly">]</span>.<span class="func">call</span>(</code></li><li class=""><code>                this,</code></li><li class=""><code>                effectivePath,</code></li><li class=""><code>                controller + <span class="S">'#'</span> + action,</code></li><li class=""><code>                skipMiddleware ? <span class="gly">[</span><span class="gly">]</span> : params.middleware,</code></li><li class=""><code>                <span class="func">getParams</span>(action, params)</code></li><li class="covered"><code>            );</code><span class="hits">21</span></li><li class="covered"><code>        <span class="gly">}</span>.<span class="func">bind</span>(this))(action);</code><span class="hits">21</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// calculate set of routes based on params.only and params.except</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">getActiveRoutes</span>(params) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> activeRoutes = <span class="gly">{</span><span class="gly">}</span>,</code></li><li class=""><code>            availableRoutes =</code></li><li class=""><code>            <span class="gly">{</span>   <span class="S">'index'</span>:   <span class="S">'GET     /'</span></code></li><li class=""><code>            ,   <span class="S">'create'</span>:  <span class="S">'POST    /'</span></code></li><li class=""><code>            ,   <span class="S">'new'</span>:     <span class="S">'GET     /new'</span></code></li><li class=""><code>            ,   <span class="S">'edit'</span>:    <span class="S">'GET     /:id/edit'</span></code></li><li class=""><code>            ,   <span class="S">'destroy'</span>: <span class="S">'DELETE  /:id'</span></code></li><li class=""><code>            ,   <span class="S">'update'</span>:  <span class="S">'PUT     /:id'</span></code></li><li class=""><code>            ,   <span class="S">'show'</span>:    <span class="S">'GET     /:id'</span></code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            availableRoutesSingleton = </code></li><li class=""><code>            <span class="gly">{</span>   <span class="S">'show'</span>:    <span class="S">'GET     /'</span></code></li><li class=""><code>            ,   <span class="S">'create'</span>:  <span class="S">'POST    /'</span></code></li><li class=""><code>            ,   <span class="S">'new'</span>:     <span class="S">'GET     /new'</span></code></li><li class=""><code>            ,   <span class="S">'edit'</span>:    <span class="S">'GET     /edit'</span></code></li><li class=""><code>            ,   <span class="S">'destroy'</span>: <span class="S">'DELETE  /'</span></code></li><li class=""><code>            ,   <span class="S">'update'</span>:  <span class="S">'PUT     /'</span></code></li><li class="covered"><code>            <span class="gly">}</span>;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (params.singleton)</code></li><li class="covered"><code>          availableRoutes = availableRoutesSingleton;</code><span class="hits">3</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// 1. only</span></code></li><li class=""><code>        <span class="kwrd">if</span> (params.only) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params.only == <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                params.only = <span class="gly">[</span>params.only<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            params.only.<span class="func">forEach</span>(<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (action <span class="kwrd">in</span> availableRoutes) <span class="gly">{</span></code></li><li class="uncovered"><code>                    activeRoutes<span class="gly">[</span>action<span class="gly">]</span> = availableRoutes<span class="gly">[</span>action<span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="C">// 2. except</span></code></li><li class=""><code>        else <span class="kwrd">if</span> (params.except) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params.except == <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                params.except = <span class="gly">[</span>params.except<span class="gly">]</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> action <span class="kwrd">in</span> availableRoutes) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (params.except.<span class="func">indexOf</span>(action) == -1) <span class="gly">{</span></code></li><li class="uncovered"><code>                    activeRoutes<span class="gly">[</span>action<span class="gly">]</span> = availableRoutes<span class="gly">[</span>action<span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="C">// 3. all</span></code></li><li class=""><code>        else <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> action <span class="kwrd">in</span> availableRoutes) <span class="gly">{</span></code></li><li class="covered"><code>                activeRoutes<span class="gly">[</span>action<span class="gly">]</span> = availableRoutes<span class="gly">[</span>action<span class="gly">]</span>;</code><span class="hits">21</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> activeRoutes;</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">getParams</span>(action, params) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> p = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">21</span></li><li class="covered"><code>        <span class="kwrd">var</span> plural = action === <span class="S">'index'</span> <span class="gly">|</span><span class="gly">|</span> action === <span class="S">'create'</span>;</code><span class="hits">21</span></li><li class=""><code>        <span class="kwrd">if</span> (params.as) <span class="gly">{</span></code></li><li class="covered"><code>            p.as = plural ? params.as : <span class="func">singularize</span>(params.as);</code><span class="hits">7</span></li><li class="covered"><code>            p.as = self.<span class="func">urlHelperName</span>(self.globPath + p.as);</code><span class="hits">7</span></li><li class=""><code>            <span class="kwrd">if</span> (action === <span class="S">'new'</span> <span class="gly">|</span><span class="gly">|</span> action === <span class="S">'edit'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                p.as = action + <span class="S">'_'</span> + p.as;</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (params.path &amp;&amp; !p.as) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> aname = plural ? name : <span class="func">singularize</span>(name);</code></li><li class="uncovered"><code>            aname = self.<span class="func">urlHelperName</span>(self.globPath + aname);</code></li><li class="uncovered"><code>            p.as = action === <span class="S">'new'</span> <span class="gly">|</span><span class="gly">|</span> action === <span class="S">'edit'</span> ? action + <span class="S">'_'</span> + aname : aname;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> p;</code><span class="hits">21</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.resource = <span class="kwrd">function</span>(name, params, actions) <span class="gly">{</span></code></li><li class="uncovered"><code>  <span class="kwrd">var</span> self = this;</code></li><li class=""><code>  <span class="C">// params are optional</span></code></li><li class="uncovered"><code>  params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>  <span class="C">// if params arg omitted, second arg may be `actions`</span></code></li><li class=""><code>  <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params == <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>      actions = params;</code></li><li class="uncovered"><code>      params = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>  <span class="gly">}</span></code></li><li class="uncovered"><code>  params.singleton = true;</code></li><li class="uncovered"><code>  <span class="kwrd">return</span> this.<span class="func">resources</span>(name, params, actions);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/*</span></code></li><li class=""><code><span class="C"> * Namespaces mapper.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     map.namespace('admin', function (admin) {</span></code></li><li class=""><code><span class="C"> *         admin.resources('user');</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.namespace = <span class="kwrd">function</span> (name, options, subroutes) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> options === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        subroutes = options;</code><span class="hits">2</span></li><li class="covered"><code>        options = null;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (options &amp;&amp; <span class="kwrd">typeof</span> options.middleware === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        options.middleware = <span class="gly">[</span>options.middleware<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="C">// store previous ns</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> old_ns = this.ns, oldGlobPath = this.globPath;</code><span class="hits">2</span></li><li class=""><code>    <span class="C">// add new ns to old (ensure tail slash present)</span></code></li><li class="covered"><code>    this.ns = old_ns + name.<span class="func">replace</span>(/\/$/, <span class="S">''</span>) + <span class="S">'/'</span>;</code><span class="hits">2</span></li><li class="covered"><code>    this.globPath = oldGlobPath + name.<span class="func">replace</span>(/\/$/, <span class="S">''</span>) + <span class="S">'/'</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span> (options &amp;&amp; options.middleware) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.middlewareStack = this.middlewareStack.<span class="func">concat</span>(options.middleware);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="func">subroutes</span>(this);</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span> (options &amp;&amp; options.middleware) <span class="gly">{</span></code></li><li class="uncovered"><code>        options.middleware.<span class="func">forEach</span>(<span class="gly">[</span><span class="gly">]</span>.pop.<span class="func">bind</span>(this.middlewareStack));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    this.ns = old_ns;</code><span class="hits">2</span></li><li class="covered"><code>    this.globPath = oldGlobPath;</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.subroutes = <span class="kwrd">function</span> (name, subroutes) <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// store previous ns</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> oldGlobPath = this.globPath;</code></li><li class=""><code>    <span class="C">// add new ns to old (ensure tail slash present)</span></code></li><li class="uncovered"><code>    this.globPath = oldGlobPath + name.<span class="func">replace</span>(/\/$/, <span class="S">''</span>) + <span class="S">'/'</span>;</code></li><li class="uncovered"><code>    <span class="func">subroutes</span>(this);</code></li><li class="uncovered"><code>    this.globPath = oldGlobPath;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Load routing map from module at `path`. Module should have `routes` function</span></code></li><li class=""><code><span class="C"> * or export single function:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     module.exports = function (map) {</span></code></li><li class=""><code><span class="C"> *         map.resources('books');</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Map.<span class="kwrd">prototype</span>.addRoutes = <span class="kwrd">function</span> (path, customBridge) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> map = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> routes = <span class="func">require</span>(path);</code></li><li class="uncovered"><code>    routes = routes.routes <span class="gly">|</span><span class="gly">|</span> routes;</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> routes !== <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Routes is not defined in '</span> + path);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="C">// temporarily change bridge</span></code></li><li class=""><code>    <span class="kwrd">if</span> (customBridge) <span class="gly">{</span></code></li><li class="uncovered"><code>        bridge = map.bridge;</code></li><li class="uncovered"><code>        map.bridge = customBridge;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> r = <span class="func">routes</span>(map);</code></li><li class=""><code>    <span class="kwrd">if</span> (customBridge) <span class="gly">{</span></code></li><li class="uncovered"><code>        map.bridge = bridge;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> r;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
        </div>
    </body>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="bootstrap.js"></script>
    <script type="text/javascript" src="coverage.js"></script>
</html>

